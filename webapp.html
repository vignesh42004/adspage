<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Download</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--tg-theme-bg-color,#fff);color:var(--tg-theme-text-color,#000);min-height:100vh;padding:20px;padding-bottom:100px}
    body.dark{background:#1a1a2e;color:#fff}
    .container{max-width:400px;margin:0 auto;text-align:center}
    .icon{width:80px;height:80px;background:linear-gradient(135deg,#e94560,#ff6b6b);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:30px auto 20px;font-size:40px;box-shadow:0 8px 25px rgba(233,69,96,0.3)}
    h1{font-size:22px;margin-bottom:8px}
    .sub{color:#888;font-size:14px;margin-bottom:30px}
    .file-card{background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:16px;padding:20px;margin-bottom:30px;text-align:left}
    body.dark .file-card{background:#2a2a3e}
    .file-name{font-size:16px;font-weight:600;margin-bottom:10px;word-break:break-all}
    .file-meta{display:flex;gap:15px;font-size:13px;color:#888}
    .timer{position:relative;width:120px;height:120px;margin:0 auto 15px}
    .timer svg{transform:rotate(-90deg)}
    .timer circle{fill:none;stroke-width:8}
    .timer-bg{stroke:#e0e0e0}
    body.dark .timer-bg{stroke:#444}
    .timer-progress{stroke:#e94560;stroke-linecap:round;stroke-dasharray:314;stroke-dashoffset:314;transition:stroke-dashoffset 1s linear}
    .timer-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:36px;font-weight:700;color:#e94560}
    .timer-label{color:#888;font-size:14px;margin-bottom:20px}
    .btn{display:none;width:100%;padding:16px;font-size:16px;font-weight:600;border:none;border-radius:12px;cursor:pointer;background:linear-gradient(135deg,#e94560,#ff6b6b);color:#fff;margin-bottom:20px}
    .btn:active{transform:scale(0.98)}
    .btn.show{display:block;animation:fadeIn .5s ease}
    .btn:disabled{opacity:.7}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .ad-section{margin-top:20px;padding:16px;background:var(--tg-theme-secondary-bg-color,#f5f5f5);border-radius:12px}
    body.dark .ad-section{background:#2a2a3e}
    .ad-label{font-size:10px;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
    .ad-box{min-height:100px;background:rgba(0,0,0,.05);border-radius:8px;display:flex;align-items:center;justify-content:center}
    body.dark .ad-box{background:rgba(255,255,255,.05)}
    .loading,.error,.success{text-align:center;padding:60px 20px}
    .spinner{width:40px;height:40px;border:3px solid rgba(233,69,96,.2);border-top-color:#e94560;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .state-icon{font-size:60px;margin-bottom:20px}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <div class="container">
    <div class="loading" id="loading"><div class="spinner"></div><p>Loading...</p></div>
    <div class="error hidden" id="error"><div class="state-icon">‚ùå</div><h2>Invalid Link</h2><p style="color:#888;margin-top:12px">Please request a new link.</p></div>
    <div class="success hidden" id="success"><div class="state-icon">‚úÖ</div><h2>File Sent!</h2><p style="color:#888;margin-top:12px">Check your chat!</p></div>
    <div class="main hidden" id="main">
      <div class="icon">üé¨</div>
      <h1>Your Movie is Ready!</h1>
      <p class="sub">Wait a moment then download</p>
      <div class="file-card">
        <div class="file-name" id="fileName">Loading...</div>
        <div class="file-meta"><span id="fileSize">üì¶ --</span><span id="fileQuality">üé• --</span></div>
      </div>
      <div id="timerSection">
        <div class="timer">
          <svg width="120" height="120" viewBox="0 0 120 120"><circle class="timer-bg" cx="60" cy="60" r="50"/><circle class="timer-progress" id="timerProgress" cx="60" cy="60" r="50"/></svg>
          <span class="timer-text" id="timerText">5</span>
        </div>
        <p class="timer-label">Please wait...</p>
      </div>
      <button class="btn" id="btn">‚¨áÔ∏è Get My File</button>
      <div class="ad-section"><div class="ad-label">Sponsored</div><div class="ad-box"><span style="color:#aaa;font-size:12px">Advertisement</span></div></div>
    </div>
  </div>
  <script>
    var tg=window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    if(tg.colorScheme==='dark')document.body.classList.add('dark');
    
    var params=new URLSearchParams(window.location.search);
    var payload=params.get('payload')||'';
    var fileName=params.get('name')||'Movie';
    var fileSize=params.get('size')||'';
    var quality=params.get('quality')||'HD';
    
    var loading=document.getElementById('loading');
    var error=document.getElementById('error');
    var success=document.getElementById('success');
    var main=document.getElementById('main');
    var timerSection=document.getElementById('timerSection');
    var timerProgress=document.getElementById('timerProgress');
    var timerText=document.getElementById('timerText');
    var btn=document.getElementById('btn');
    
    if(!payload){
      loading.classList.add('hidden');
      error.classList.remove('hidden');
    }else{
      setTimeout(function(){
        loading.classList.add('hidden');
        main.classList.remove('hidden');
        try{
          document.getElementById('fileName').textContent=decodeURIComponent(fileName);
          document.getElementById('fileSize').textContent='üì¶ '+decodeURIComponent(fileSize);
          document.getElementById('fileQuality').textContent='üé• '+decodeURIComponent(quality);
        }catch(e){}
        startTimer();
      },800);
    }
    
    var WAIT=5;
    var remaining=WAIT;
    var circ=2*Math.PI*50;
    
    function startTimer(){
      var interval=setInterval(function(){
        remaining--;
        timerText.textContent=remaining;
        timerProgress.style.strokeDashoffset=circ*(1-(WAIT-remaining)/WAIT);
        if(remaining<=0){
          clearInterval(interval);
          showBtn();
        }
      },1000);
    }
    
    function showBtn(){
      timerSection.style.display='none';
      btn.classList.add('show');
      tg.MainButton.setText('‚¨áÔ∏è Get My File');
      tg.MainButton.color='#e94560';
      tg.MainButton.textColor='#ffffff';
      tg.MainButton.show();
      tg.MainButton.onClick(download);
    }
    
    function download(){
      btn.disabled=true;
      btn.textContent='‚è≥ Sending...';
      tg.MainButton.setText('‚è≥ Sending...');
      tg.MainButton.disable();
      tg.sendData(JSON.stringify({action:'download',payload:payload}));
      setTimeout(function(){
        main.classList.add('hidden');
        success.classList.remove('hidden');
        tg.MainButton.hide();
        setTimeout(function(){tg.close();},2000);
      },1000);
    }
    
    btn.addEventListener('click',download);
    tg.BackButton.onClick(function(){tg.close();});
  </script>
</body>
</html>
