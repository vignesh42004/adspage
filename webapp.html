<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Download Movie</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #ffffff;
      --text: #000000;
      --card: #f5f5f5;
      --accent: #e94560;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color, var(--bg));
      color: var(--tg-theme-text-color, var(--text));
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
    }
    
    body.dark { --bg: #1a1a2e; --text: #fff; --card: #2a2a3e; }
    
    .container { max-width: 400px; margin: 0 auto; }
    
    .header { text-align: center; margin-bottom: 30px; }
    
    .icon {
      width: 80px; height: 80px;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
      box-shadow: 0 8px 25px rgba(233, 69, 96, 0.3);
    }
    
    .header h1 { font-size: 22px; margin-bottom: 8px; }
    .header p { color: #888; font-size: 14px; }
    
    .file-card {
      background: var(--tg-theme-secondary-bg-color, var(--card));
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .file-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      word-break: break-all;
    }
    
    .file-meta { display: flex; gap: 16px; font-size: 13px; color: #888; }
    
    .timer-section { text-align: center; margin-bottom: 24px; }
    
    .timer-circle {
      position: relative;
      width: 120px; height: 120px;
      margin: 0 auto 16px;
    }
    
    .timer-circle svg { transform: rotate(-90deg); }
    .timer-circle circle { fill: none; stroke-width: 8; }
    .timer-bg { stroke: #e0e0e0; }
    body.dark .timer-bg { stroke: #444; }
    
    .timer-progress {
      stroke: var(--accent);
      stroke-linecap: round;
      stroke-dasharray: 314;
      stroke-dashoffset: 314;
      transition: stroke-dashoffset 1s linear;
    }
    
    .timer-text {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .timer-label { color: #888; font-size: 14px; }
    
    .download-btn {
      display: none;
      width: 100%;
      padding: 16px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, #e94560, #ff6b6b);
      color: white;
      margin-bottom: 24px;
    }
    
    .download-btn:active { transform: scale(0.98); }
    .download-btn.show { display: block; animation: fadeIn 0.5s ease; }
    .download-btn:disabled { opacity: 0.7; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ad-section {
      margin-top: 20px;
      padding: 16px;
      background: var(--tg-theme-secondary-bg-color, var(--card));
      border-radius: 12px;
      text-align: center;
    }
    
    .ad-label {
      font-size: 10px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    
    .ad-container {
      min-height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.05);
      border-radius: 8px;
    }
    
    body.dark .ad-container { background: rgba(255,255,255,0.05); }
    
    .loading { text-align: center; padding: 60px 20px; }
    
    .spinner {
      width: 40px; height: 40px;
      border: 3px solid rgba(233, 69, 96, 0.2);
      border-top-color: #e94560;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error-state, .success-state {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }
    
    .error-state.show, .success-state.show { display: block; }
    
    .state-icon { font-size: 60px; margin-bottom: 20px; }
    .state-title { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
    .state-text { color: #888; font-size: 14px; line-height: 1.5; }
    
    .main-state.hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>

    <div class="error-state" id="errorState">
      <div class="state-icon">‚ùå</div>
      <div class="state-title">Invalid Link</div>
      <p class="state-text">This link is invalid or expired.<br>Please request a new one.</p>
    </div>

    <div class="success-state" id="successState">
      <div class="state-icon">‚úÖ</div>
      <div class="state-title">File Sent!</div>
      <p class="state-text">Check your chat with the bot.<br>Your movie is on the way!</p>
    </div>

    <div class="main-state hidden" id="mainState">
      <div class="header">
        <div class="icon">üé¨</div>
        <h1>Your Movie is Ready!</h1>
        <p>Wait a moment then download</p>
      </div>

      <div class="file-card">
        <div class="file-name" id="fileName">Loading...</div>
        <div class="file-meta">
          <span id="fileSize">üì¶ --</span>
          <span id="fileQuality">üé• --</span>
        </div>
      </div>

      <div class="timer-section" id="timerSection">
        <div class="timer-circle">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle class="timer-bg" cx="60" cy="60" r="50"/>
            <circle class="timer-progress" id="timerProgress" cx="60" cy="60" r="50"/>
          </svg>
          <span class="timer-text" id="timerText">5</span>
        </div>
        <p class="timer-label">Please wait...</p>
      </div>

      <button class="download-btn" id="downloadBtn">‚¨áÔ∏è Get My File</button>

      <div class="ad-section">
        <div class="ad-label">Sponsored</div>
        <div class="ad-container" id="adContainer">
          <!-- PASTE YOUR AD CODE HERE -->
          <span style="color: #aaa; font-size: 12px;">Advertisement</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    if (tg.colorScheme === 'dark') document.body.classList.add('dark');

    const params = new URLSearchParams(window.location.search);
    const payload = params.get('payload') || '';
    const fileName = params.get('name') || 'Movie';
    const fileSize = params.get('size') || '';
    const quality = params.get('quality') || 'HD';

    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const successState = document.getElementById('successState');
    const mainState = document.getElementById('mainState');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const fileQualityEl = document.getElementById('fileQuality');
    const timerSection = document.getElementById('timerSection');
    const timerProgress = document.getElementById('timerProgress');
    const timerText = document.getElementById('timerText');
    const downloadBtn = document.getElementById('downloadBtn');

    if (!payload) {
      loadingState.style.display = 'none';
      errorState.classList.add('show');
    } else {
      setTimeout(() => {
        loadingState.style.display = 'none';
        mainState.classList.remove('hidden');
        
        try {
          fileNameEl.textContent = decodeURIComponent(fileName);
          fileSizeEl.textContent = 'üì¶ ' + decodeURIComponent(fileSize);
          fileQualityEl.textContent = 'üé• ' + decodeURIComponent(quality);
        } catch(e) {
          fileNameEl.textContent = fileName;
        }
        
        startTimer();
      }, 800);
    }

    const WAIT_TIME = 5;
    let remaining = WAIT_TIME;
    const circumference = 2 * Math.PI * 50;

    function startTimer() {
      const interval = setInterval(() => {
        remaining--;
        timerText.textContent = remaining;
        timerProgress.style.strokeDashoffset = circumference * (1 - (WAIT_TIME - remaining) / WAIT_TIME);
        
        if (remaining <= 0) {
          clearInterval(interval);
          showDownload();
        }
      }, 1000);
    }

    function showDownload() {
      timerSection.style.display = 'none';
      downloadBtn.classList.add('show');
      
      tg.MainButton.setText('‚¨áÔ∏è Get My File');
      tg.MainButton.color = '#e94560';
      tg.MainButton.textColor = '#ffffff';
      tg.MainButton.show();
      tg.MainButton.onClick(handleDownload);
    }

    function handleDownload() {
      downloadBtn.disabled = true;
      downloadBtn.textContent = '‚è≥ Sending...';
      tg.MainButton.setText('‚è≥ Sending...');
      tg.MainButton.disable();
      
      tg.sendData(JSON.stringify({
        action: 'download',
        payload: payload
      }));
      
      setTimeout(() => {
        mainState.classList.add('hidden');
        successState.classList.add('show');
        tg.MainButton.hide();
        
        setTimeout(() => tg.close(), 2000);
      }, 1000);
    }

    downloadBtn.addEventListener('click', handleDownload);
    tg.BackButton.onClick(() => tg.close());
  </script>
</body>
</html>
